---
title: "Multi-Wavelength Bioassay Analysis Report"
author: "Kristof Moeller (IAEA, Monaco) and Arnold Molina Porras (Universidad de Costa Rica)"
output:
  html_document:
    df_print: paged
    self_contained: true
    toc: true
    toc_float: true
  pdf_document:
    toc: true
  word_document:
    toc: true
params:
  output_dir: NULL
  wavelengths: NULL
  lang: "en"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

library(dplyr)
library(knitr)
library(kableExtra)
library(purrr)
library(jsonlite)

output_dir <- normalizePath(params$output_dir, winslash = "/", mustWork = TRUE)

wavelengths <- params$wavelengths
if (is.null(wavelengths) || length(wavelengths) == 0) {
  stop("No wavelengths specified in parameters")
}

lang <- params$lang %||% "en"
`%||%` <- function(x, y) if (is.null(x)) y else x

script_dir <- tryCatch({
  rmd_path <- knitr::current_input()
  if (!is.null(rmd_path) && rmd_path != "" && rmd_path != ".") {
    normalizePath(dirname(rmd_path), winslash = "/")
  } else {
    "."
  }
}, error = function(e) ".")

# Source i18n translations (search multiple locations)
i18n_found <- FALSE
for (i18n_candidate in c(
  file.path(script_dir, "i18n.R"),
  file.path(dirname(script_dir), "i18n.R"),
  "../i18n.R",
  "i18n.R",
  file.path(dirname(output_dir), "i18n.R")
)) {
  if (file.exists(i18n_candidate)) {
    source(i18n_candidate)
    i18n_found <- TRUE
    break
  }
}
if (!i18n_found) {
  tr <- function(key, lang = "en", ...) paste0("[", key, "]")
}

write_json_safe <- function(x, file) {
  dir.create(dirname(file), recursive = TRUE, showWarnings = FALSE)
  jsonlite::write_json(x, path = file, pretty = TRUE, auto_unbox = TRUE, null = "null")
}

message(sprintf("Processing %d wavelengths: %s", 
                length(wavelengths), paste(wavelengths, collapse = ", ")))
```

# `r tr("multi_overview", lang)`

`r tr("multi_overview_desc", lang, length(wavelengths), paste(wavelengths, collapse = ", "))`

`r tr("multi_compare", lang)`

- `r tr("multi_benefit1", lang)`
- `r tr("multi_benefit2", lang)`
- `r tr("multi_benefit3", lang)`

**`r tr("multi_sections", lang)`**

- `r tr("multi_exec_summary", lang)`
- `r tr("multi_detailed", lang)`

---

## `r tr("exec_summary_title", lang)`

```{r wavelength-summary, results='asis'}
tryCatch({

summary_data <- list()

for (wl in wavelengths) {
  csv_file <- file.path(output_dir, paste0("long_data_output_", wl, ".csv"))
  wl_output_dir <- file.path(output_dir, wl)
  stats_file <- file.path(wl_output_dir, "model_stats.json")
  summary_file <- file.path(wl_output_dir, "unknown_results_summary.csv")

  wl_info <- list(wavelength = wl, n_standards = 0L, n_samples = 0L,
                  n_quantified = 0L, r_squared = NA_real_, rmse = NA_real_,
                  ic50 = NA_real_, mean_cv = NA_real_)

  if (file.exists(csv_file)) {
    data_long <- read.csv(csv_file, stringsAsFactors = FALSE)
    wl_info$n_standards <- sum(data_long$SampleType == "Standard", na.rm = TRUE)
    wl_info$n_samples <- sum(data_long$SampleType == "Sample", na.rm = TRUE)

    if (file.exists(stats_file)) {
      stats <- tryCatch(jsonlite::fromJSON(stats_file), error = function(e) NULL)
      if (!is.null(stats)) {
        safe_num <- function(x) tryCatch(as.numeric(x[[1]]), error = function(e) NA_real_, warning = function(w) NA_real_)
        wl_info$r_squared <- safe_num(stats$r_squared)
        wl_info$rmse      <- safe_num(stats$rmse)
        wl_info$ic50      <- safe_num(stats$ic50)
        wl_info$mean_cv   <- safe_num(stats$mean_sample_cv)
      }
    }

    if (file.exists(summary_file)) {
      results <- tryCatch(read.csv(summary_file, stringsAsFactors = FALSE), error = function(e) data.frame())
      wl_info$n_quantified <- nrow(results)
    }
  }

  summary_data[[wl]] <- wl_info
}

if (length(summary_data) > 0) {
  fmt_num <- function(val, digits) {
    if (is.null(val) || length(val) == 0 || !is.numeric(val) || is.na(val) || !is.finite(val)) return("\u2014")
    format(round(val, digits), nsmall = digits)
  }

  summary_df <- data.frame(
    Wavelength = sapply(summary_data, function(x) x$wavelength),
    R2 = sapply(summary_data, function(x) fmt_num(x$r_squared, 4)),
    RMSE = sapply(summary_data, function(x) fmt_num(x$rmse, 3)),
    IC50 = sapply(summary_data, function(x) {
      v <- x$ic50
      if (is.null(v) || !is.numeric(v) || is.na(v) || !is.finite(v)) "\u2014"
      else format(round(v, 1), nsmall = 1, big.mark = ",")
    }),
    Standards = sapply(summary_data, function(x) x$n_standards),
    Samples = sapply(summary_data, function(x) x$n_samples),
    Quantified = sapply(summary_data, function(x) x$n_quantified),
    Mean_CV = sapply(summary_data, function(x) {
      v <- x$mean_cv
      if (is.null(v) || !is.numeric(v) || is.na(v) || !is.finite(v)) "\u2014"
      else paste0(format(round(v, 1), nsmall = 1), "%")
    }),
    stringsAsFactors = FALSE
  )

  names(summary_df) <- c(
    tr("col_wavelength", lang), tr("col_r2", lang), tr("col_rmse", lang),
    tr("col_ic50", lang), tr("col_standards", lang), tr("col_samples", lang),
    tr("col_quantified", lang), tr("col_mean_cv", lang)
  )

  # Use format appropriate for output type
  out_fmt <- knitr::opts_knit$get("rmarkdown.pandoc.to")
  if (!is.null(out_fmt) && out_fmt %in% c("docx", "latex")) {
    print(kable(summary_df, caption = tr("data_overview", lang), format = "pandoc"))
  } else {
    print(kable(summary_df, caption = tr("data_overview", lang)) %>%
      kableExtra::kable_styling(full_width = FALSE, position = "center"))
  }

  rmse_vals <- sapply(summary_data, function(x) {
    v <- x$rmse
    if (is.null(v) || !is.numeric(v) || is.na(v) || !is.finite(v)) NA_real_ else v
  })
  rmse_valid <- rmse_vals[!is.na(rmse_vals)]

  if (length(rmse_valid) > 0) {
    best_wl <- names(which.min(rmse_valid))
    best_rmse <- min(rmse_valid)
    cat("\n\n")
    cat(tr("recommended_wavelength", lang, best_wl, best_rmse))
    cat("\n\n")
  }
}

}, error = function(e) {
  cat(sprintf("\n\n**Executive summary could not be generated:** %s\n\n", e$message))
})
```

---

```{r generate-wavelength-reports, results='asis'}
preprocess_file <- file.path(script_dir, "preprocess_multiwavelength.R")
if (file.exists(preprocess_file)) {
  source(preprocess_file)
} else {
  preprocess_template_chunks <- function(template_path, label_prefix, temp_dir = tempdir()) {
    template_lines <- readLines(template_path, warn = FALSE)
    chunk_pattern <- "^```\\{r\\s+([^,}]+)"
    processed_lines <- sapply(template_lines, function(line) {
      if (grepl(chunk_pattern, line)) {
        chunk_match <- regmatches(line, regexpr(chunk_pattern, line, perl = TRUE))
        if (length(chunk_match) > 0) {
          chunk_name <- sub("^```\\{r\\s+", "", chunk_match)
          new_chunk_name <- paste0(label_prefix, "-", chunk_name)
          line <- sub(paste0("(```\\{r\\s+)", chunk_name),
                      paste0("\\1", new_chunk_name), line)
        }
      }
      return(line)
    }, USE.NAMES = FALSE)
    temp_file <- file.path(temp_dir, paste0(label_prefix, "_", basename(template_path)))
    writeLines(processed_lines, temp_file)
    return(temp_file)
  }
}

for (i in seq_along(wavelengths)) {
  wl <- wavelengths[i]
  
  cat(sprintf("\n\n# %s\n\n", tr("wavelength_analysis", lang, wl)))
  cat(sprintf("**%s**\n\n", tr("analysis_n_of", lang, i, length(wavelengths))))
  
  csv_file <- file.path(output_dir, paste0("long_data_output_", wl, ".csv"))
  if (!file.exists(csv_file)) {
    cat(sprintf("**Error:** Data file not found for %s\n\n", wl))
    next
  }
  
  wl_output_dir <- file.path(output_dir, wl)
  if (!dir.exists(wl_output_dir)) dir.create(wl_output_dir, recursive = TRUE, showWarnings = FALSE)
  
  file.copy(from = csv_file, to = file.path(wl_output_dir, "long_data_output.csv"), overwrite = TRUE)
  
  config_files <- c("assay_config.json", "qc_params.json", "notes.json",
                    "sample_processing_config.json", "tissue_weights.json", "excluded_wells.json")
  for (cfg_file in config_files) {
    src <- file.path(output_dir, cfg_file)
    if (file.exists(src)) file.copy(src, file.path(wl_output_dir, cfg_file), overwrite = TRUE)
  }
  
  tryCatch({
    template_path <- file.path(script_dir, "unified_analysis_template.Rmd")
    if (!file.exists(template_path)) {
      cat(sprintf("**Error:** Template not found at `%s`\n\n", template_path))
    } else {
      label_prefix <- paste0("wl", gsub("[^a-zA-Z0-9]", "", wl))
      preprocessed_template <- preprocess_template_chunks(template_path, label_prefix)
      wl_env <- new.env(parent = environment())
      wl_env$params <- list(output_dir = wl_output_dir, lang = lang)
      result <- knitr::knit_child(preprocessed_template, envir = wl_env, quiet = TRUE)
      cat(result, sep = "\n")
      unlink(preprocessed_template)
    }
  }, error = function(e) {
    cat(sprintf("**Error rendering %s analysis:**\n\nError: %s\n\n", wl, e$message))
  })
  
  cat("\n\n---\n\n")
}
```

# `r tr("overall_conclusions", lang)`

```{r final-comparison, results='asis'}
cat(sprintf("## %s\n\n", tr("wavelength_performance", lang)))
cat(sprintf("**%s**\n\n", tr("recommendations", lang)))
cat(sprintf("- %s\n", tr("rec_r2", lang)))
cat(sprintf("- %s\n", tr("rec_cv", lang)))
cat(sprintf("- %s\n\n", tr("rec_separation", lang)))
```

---

**`r tr("report_generated", lang)`** `r Sys.Date()`
**`r tr("contact", lang)`** kr.moeller@iaea.org
**`r tr("feedback", lang)`** [`r tr("online_form", lang)`](https://forms.office.com/e/q8eqJfp4QM)

*`r tr("automated_multi", lang)`*
